clear all
close all
warning('off');

execution_datetime = get_datetime_str();

diary(fullfile('log',[execution_datetime,'.txt']));

img_path = 'D:\Archivi\CNR\Dataset\GRAMPI\140726_P_SCT';
models_path = 'models';
output_path = 'output\test';
output_date = '170119';
visible_controls = 'On';

main_fig = figure('Units', 'normalized', ...
    'Position', [0.01, 0.05, 0.5, 0.85], ...
    'Resize', 'off', ...
    'DockControls', 'Off', ...
    'MenuBar', 'figure', ...
    'Name', 'New Image', ...
    'CloseRequestFcn', @close_all ...
    );

prev_btn = uicontrol('Style', 'pushbutton',...
    'String', 'Prev', ...
'Visible', visible_controls, ...
'Units', 'normalized', ...
'Position', [0.3 0.01 0.2 0.05], ...
'Callback', {@change_img, main_fig});

next_btn = uicontrol('Style', 'pushbutton',...
    'String', 'Next', ...
'Visible', visible_controls, ...
'Units', 'normalized', ...
'Position', [0.5 0.01 0.2 0.05], ...
'Callback', {@change_img, main_fig});

img_files = dir(img_path);
if ~isfield(img_files, 'folder')
    for i = 1:numel(img_files)
        img_files(i).folder = img_path;
    end
end
img_files([img_files.isdir]) = [];
img_files(cellfun(@(x)strcmp(x(1), '.'), {img_files.name})) = [];

setappdata(main_fig, 'img_idx', 0);
setappdata(main_fig, 'img_files', img_files);
setappdata(main_fig, 'main_txt', annotation('textbox', [0.05 0.95 0.8 0.05], ...
    'String', 'Click on Next to begin', ...
    'FitBoxToText','on'));
setappdata(main_fig, 'counter_txt', annotation('textbox', [0.85 0.01 0.05 0.05], ...
    'String', sprintf('%03d/%03d', 0, numel(img_files)), ...
    'FitBoxToText','on',...
    'ButtonDownFcn', {@set_idx, main_fig}));
setappdata(main_fig, 'current_label', annotation('textbox', [0.85 0.95 0.05 0.05], ...
    'String', 'NOT LABELLED', ...
    'FitBoxToText','on'));
setappdata(main_fig, 'output_path', output_path);
setappdata(main_fig, 'output_date', output_date);
setappdata(main_fig, 'execution_datetime', execution_datetime);

models_fig = figure('Units', 'normalized', ...
            'Position', [0.55, 0.05, 0.4, 0.9], ...
            'Resize', 'on', ...
            'DockControls', 'off', ...
            'MenuBar', 'none', ...
            'Name', 'Known Dolphins', ...
            'CloseRequestFcn', @close_all ...
            );

setappdata(models_fig, 'models_fig_subplot_h', []);

manual_label = uicontrol('Style', 'edit',...
                            'Visible', visible_controls, ...
                            'Units', 'normalized', ...
                            'Position', [0.15 0.025 0.3 0.05], ...
                            'Callback', {@change_label, main_fig, 'manual_label'}, ...
                            'String', 'Insert a manual label and press enter');

                        
models_folder = dir(models_path);
models_folder(cellfun(@(x)strcmp(x(1), '.'), {models_folder.name})) = [];
models_folder(~[models_folder.isdir]) = [];

folder_popup = uicontrol('Style', 'popupmenu',...
                            'Visible', visible_controls, ...
                            'Units', 'normalized', ...
                            'Position', [0.5 0.025 0.3 0.05], ...
                            'Callback', {@change_models_folder, models_path, models_fig, main_fig}, ...
                            'String', {models_folder.name});

